name: Deploy Strapi to EC2
on:
  push:
    branches: [ main ]
  workflow_dispatch:
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      - run: npm ci
      - run: npm test || echo "No tests defined, skipping..." 
  deploy:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Build application
        run: npm run build
        
      - name: Generate deployment package
        run: |
          mkdir -p deployment
          # Include only necessary files for production
          cp -r build config database public src package.json package-lock.json .env.example deployment/
          cd deployment && tar -czf ../deployment.tar.gz .
          # Check size of deployment package
          ls -lh ../deployment.tar.gz
          
      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H 13.126.228.103 >> ~/.ssh/known_hosts
          
      - name: Check EC2 disk space
        run: |
          ssh ubuntu@13.126.228.103 "df -h && echo 'Available disk space shown above'"
          
      - name: Deploy to EC2 with SCP retry
        run: |
          # Try SCP with verbose output
          echo "Attempting SCP file transfer..."
          scp -v deployment.tar.gz ubuntu@13.126.228.103:~/deployment.tar.gz || TRANSFER_FAILED=true
          
          if [ "$TRANSFER_FAILED" = true ]; then
            echo "SCP failed, trying alternative transfer method with split files..."
            # Split the deployment package into smaller chunks
            mkdir -p chunks
            split -b 5M deployment.tar.gz chunks/deployment.part.
            
            # Transfer chunks separately
            for chunk in chunks/deployment.part.*; do
              echo "Transferring chunk: $chunk"
              scp -v "$chunk" ubuntu@13.126.228.103:~/"$(basename $chunk)" || exit 1
            done
            
            # Reassemble on the server
            ssh ubuntu@13.126.228.103 "cat ~/deployment.part.* > ~/deployment.tar.gz && rm ~/deployment.part.*"
          fi
          
          # Verify the file was transferred correctly
          ssh ubuntu@13.126.228.103 "ls -lh ~/deployment.tar.gz"
          
      - name: Deploy on EC2
        run: |
          ssh ubuntu@13.126.228.103 << 'EOF'
            # Check if deployment package exists
            if [ ! -f ~/deployment.tar.gz ]; then
              echo "ERROR: deployment.tar.gz not found. Transfer failed."
              exit 1
            fi
            
            # Stop the current Strapi application
            cd ~/edtech_backend || mkdir -p ~/edtech_backend
            pm2 stop strapi || true
            
            # Backup the current version
            timestamp=$(date +%Y%m%d%H%M%S)
            mkdir -p ~/backups
            tar -czf ~/backups/edtech_backend-backup-$timestamp.tar.gz ~/edtech_backend --exclude=node_modules || echo "Warning: Backup failed, continuing anyway"
            
            # Backup important files
            if [ -f ~/edtech_backend/.env ]; then
              cp ~/edtech_backend/.env ~/edtech_env_backup
            fi
            
            # Also backup database config if it exists separately
            if [ -d ~/edtech_backend/config/database ]; then
              mkdir -p ~/database_config_backup
              cp -r ~/edtech_backend/config/database ~/database_config_backup
            fi
            
            # Create a temporary directory for extraction
            rm -rf ~/edtech_temp
            mkdir -p ~/edtech_temp
            tar -xzf ~/deployment.tar.gz -C ~/edtech_temp
            
            # Clear only specific directories to preserve data
            rm -rf ~/edtech_backend/build ~/edtech_backend/config ~/edtech_backend/public
            
            # Copy new files
            cp -r ~/edtech_temp/* ~/edtech_backend/
            
            # Restore the .env file
            if [ -f ~/edtech_env_backup ]; then
              cp ~/edtech_env_backup ~/edtech_backend/.env
            else
              # If no .env backup, copy example
              if [ -f ~/edtech_backend/.env.example ]; then
                cp ~/edtech_backend/.env.example ~/edtech_backend/.env
                echo "WARNING: Using .env.example as .env. Please update with correct values."
              fi
            fi
            
            # Restore database config if it was backed up
            if [ -d ~/database_config_backup ]; then
              mkdir -p ~/edtech_backend/config/
              cp -r ~/database_config_backup/* ~/edtech_backend/config/database/
            fi
            
            # Install production dependencies
            cd ~/edtech_backend
            echo "Installing production dependencies..."
            npm install --production --no-audit --no-fund
            
            # Restart Strapi with PM2
            echo "Starting Strapi application..."
            pm2 restart strapi || pm2 start npm --name "strapi" -- run start
            
            # Show logs to help with debugging
            echo "Showing Strapi logs for debugging:"
            sleep 10
            pm2 logs strapi --lines 20 --nostream
            
            # Clean up
            rm ~/deployment.tar.gz || true
            rm -f ~/edtech_env_backup || true
            rm -rf ~/database_config_backup || true
            rm -rf ~/edtech_temp || true
            
            # Validate deployment
            echo "Deployment completed. Checking Strapi status..."
            pm2 status
          EOF
          
      - name: Verify deployment
        run: |
          echo "Waiting for application to start..."
          sleep 60
          curl -v --max-time 30 https://api.explored.co.in || echo "Warning: Verification check failed, but deployment might still be successful"
          # Note: The curl command might fail if the application is still starting up or the endpoint requires authentication
          echo "Deployment process completed!"
